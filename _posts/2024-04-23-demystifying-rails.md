---
# layout: posts
# author_profile: true
permalink: /demystifying-rails
title: Demystifying Rails - Ruby Oceania / AU Melbourne talk
excerpt: "How to learn and demystify rails"
# last_modified_at: 2016-11-03T11:13:12-04:00
collection: learning
categories:
  - software_engineering
  - learning
tags:
  - software_engineering
  - learning
  - talks
toc: true
toc_sticky: true
# toc_label: "My Table of Contents"
# toc_icon: "cog"
# header:
#   video:
#     id: _mrF0pp8LIE
#     provider: youtube

---

# Action Plan

```ruby
1. how to demystify *Ruby on Rails*
2. some demo code
3. parts forming *Ruby on Rails*:
  - Bundler, Rake, Rack
  - ActiveSupport, ActiveModel / ActiveRecord
  - ActionMailer, ActionCable, ActionView, ActionController
  - ActiveJob, Routes, DSLs, ...
```

---

# About me

```ruby
class Friendlyantz
  def initialize
    @name = 'Anton'  || :friendlyantz
    @title = 'Extreme Programmer'
    @work = FRESHOüå∂Ô∏è
  end
  
  def find_more = 'https://friendlyantz.me/'
```

---

## Thailand

<img height="500" alt="image" src="https://github.com/friendlyantz/friendlyantz/assets/70934030/442c5a59-9abd-4df3-a02d-103d552a40ae">
<img height="500" alt="image" src="https://github.com/friendlyantz/friendlyantz/assets/70934030/d49db1de-4d0e-497f-bbda-1434d51ce9ec">
<img height="500" alt="image" src="https://github.com/friendlyantz/friendlyantz/assets/70934030/c55adaf5-b703-40ee-bd72-a7a6d7067818">

---
![fit_2048](https://github.com/friendlyantz/friendlyantz/assets/70934030/8eb5626b-bea8-4266-8966-e0803ff3fffb)

---

Ruby Conf AU - Sydney2024

<img height="500" alt="image" src="https://pbs.twimg.com/media/GK-BCCTawAAzlHT?format=jpg&name=large">

---

<img height="500" alt="image" src="https://pbs.twimg.com/media/GK-AOCWaAAA0zXP?format=jpg&name=large">

---

# Demystifying Rails

---

# Why

1. Understand where Ruby ends and Rails starts
2. Make architectural decisions and when/how to use RoR
3. Break RoR conventions, go outside MVC

---

<img width="1003" alt="image" src="https://github.com/friendlyantz/friendlyantz/assets/70934030/b449d797-0b96-43b6-b05e-9f2170d7af6f">
DSL?
> https://www.youtube.com/watch?v=gXwRs-FwcmE

---

# Active or Action?

---

# Bundler

---

```ruby
bundle exec [command]
bundle install

bundle init # create Gemfile
bundle add activesupport # it adds versions, so remove them if required
bundle remove [gemname]
```

---

## Bundle more

```ruby
bundle show # show all gems in Gemfile
bundle show [gemname] # show path
bundle info [gemname]
bundle open [gemname] # open gem in editor

bundle console # open irb with gems loaded
# [DEPRECATED] bundle console will be replaced by `bin/console` generated by `bundle gem <name>`
```

---

# Rake

---

```ruby
task default: :create_files

directory 'ship_itüö¢'

task :touch => 'ship_itüö¢' do
  touch 'ship_itüö¢/file1.txt'
end

# RTFM
ri FileUtils
```

---
# Rack

---

```ruby
# config.ru
run do |env|
  [200, { "some_header" => "lalala"}, ["Hello World"]]
end
```

```ruby
rackup
```

```sh
curl -i http://127.0.0.1:9292
```

---

# Active Support

---

`presence` / `blank?` / `present?`
![image](https://github.com/friendlyantz/friendlyantz/assets/70934030/01430dd0-cc21-42fe-a007-58910a373bc7)

---

```ruby
[{a:1, b: 2}, {a:2}].pluck(:b) # [3, nil]
1_234_567_890_123.to_fs(:human_size) # => 1.12 TB
{ a: 1, b: 1 }.merge(a: 0, c: 2) # {:a=>0, :b=>1, :c=>2}
" \n  foo\n\r \t bar \n".squish # => "foo bar"
numbers.extract! { |number| number.odd? } 
invoices.index_by(&:number)
[1,2,4].exclude? 3 # true
```

---

```ruby
class Account
  with_options dependent: :destroy do |assoc|
     assoc.has_many :customers
     assoc.has_many :products
     assoc.has_many :invoices
     assoc.has_many :expenses
  end
  # has_many :customers, dependent: :destroy
  
  with_options on: :invoicing do
    validates :something, presence: true
  end
end

class User < ApplicationRecord
  has_one :profile

  delegate :name, to: :profile
end
```
---

# [ActiveModel](https://guides.rubyonrails.org/active_model_basics.html)

---

```ruby
# similar to `ActiveRecord::Base`
include ActiveModel::API
   include ActiveModel::Validations
   extend ActiveModel::Translation # i18n gem integration
   include ActiveModel::Conversion # .persisted? and  `id` methods

extend ActiveModel::Callbacks # before_update :reset_me
include ActiveModel::AttributeMethods # define meta attributes
include ActiveModel::Dirty # model.changed?
include ActiveModel::Serialization
include ActiveModel::SecurePassword
```

---
# ActiveRecord

---

```ruby
ActiveRecord
	.is_kind_of_an ActiveModel
	.with DB persistence layer

# named after a **Active Record** design pattern:
"An object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data."
                                         > Martin Fowler
```

---

```ruby
require 'active_record'

ActiveRecord::Base.establish_connection(
  adapter: 'sqlite3',
  database: 'sample.sqlite3'
)

class User < ActiveRecord::Base
  validates_presence_of :name, on: :create

  has_many :posts
end
```
ActiveRecord scripting can be used for data manipulation / relocation / sanitisation scripts

---

```ruby
module ActiveRecord # add in spec_helper.rb, or other test setup files
  class LogSubscriber < ActiveSupport::LogSubscriber
    def sql(event)
      if /FROM "some_table" WHERE "some_condition"/.match?(event.payload[:sql])
        Rails.logger.info "SQL FOUND #{caller_locations[15...150]}" 
        binding.irb if ENV["QUERY_BINDING"]
      end
    end
  end
end

ActiveRecord::LogSubscriber.attach_to :active_record
```
[sauce]([https://www.mayerdan.com/ruby/2022/06/27/rails-query-tracing](https://www.mayerdan.com/ruby/2022/06/27/rails-query-tracing))

---

# ActiveJob

---

- [Sidekiq](https://github.com/mperham/sidekiq/wiki/Active-Job)- Redis backed. does not need Rails!
- [Good Job](https://github.com/bensheldon/good_job#readme) - PostgreSQL backed. needs Rails
- [Resque](https://github.com/resque/resque/wiki/ActiveJob) - Redis-backed. does not need Rails!
- [Solid Queue](https://github.com/rails/solid_queue) - new Rails OG. MySQL, PostgreSQL or SQLite backed. inspired by `Resque` and `GoodJob`
- [Que](https://github.com/que-rb/que#additional-rails-specific-setup)
- [Sneakers](https://github.com/jondot/sneakers/wiki/How-To:-Rails-Background-Jobs-with-ActiveJob)
- [Sucker Punch](https://github.com/brandonhilkert/sucker_punch#active-job)
- [Queue Classic](https://github.com/QueueClassic/queue_classic#active-job)
- [Delayed Job](https://github.com/collectiveidea/delayed_job#active-job)

---
# ActionMailer

---

```ruby
require 'action_mailer'

class LalaMailer < ActionMailer::Base
  def notify
    attachments['roo.png'] = File.read('./roo.png')
    
    mail(
      to: 'ruby@australia.com',
      from: 'friendlyantz@pm.me',
      subject: 'Hello, World!'
    ) do |format|
      format.text { 'This is my text message' }
      format.html { '<h1>this is my html message</h1>' }
    end
  end
end

LalaMailer.notify.deliver_now
```

---

- ActionCable
- ActionView 
- Templating
- ActionController
- ActionPack
- ActiveStorage
- Routing -> try Hanami, Sinatra, etc
- [Zeitwerk](https://github.com/fxn/zeitwerk) code loader for Ruby, used in Rails now
- [brakeman](https://github.com/presidentbeef/brakeman) - will be part of Rails 8 by default

---
# run minimalistic rails

---

```ruby
rails new myapp --minimal # 5 sec to generate, vs 17 sec normal (hot start)

rails new myapp --api
rails new myapp --skip-action-mailer # etc

rails new --help
```

---

# Rails CLI

---

```sh
rails --help
rails generate --help
rails generate model --help
```

---

# Conclusion

---
```ruby

- try and build stuff in isolation:
	- `Rake` scripts, `Rack`up server,
	- `bundle init/add/console`
	- use `Active Support`  to extend Ruby for code challenges
	- user `ActiveRecord + Rack` to build a basic app
- start simple and minimal, YAGNI, use minimal presets
rails new myapp --minimal
```

----

# References

1. [free Rake course at 'graceful.dev' by Avdi Grim](https://graceful.dev/courses/the-freebies/modules/rake-and-project-automation/topic/episode-129-rake/)
2. [rubyonrails guides](https://guides.rubyonrails.org)
3. [Ruby on Rulers by Noah Gibbs](https://github.com/noahgibbs/rulers)
4. [rebuilding Rails by Noah Gibbs](https://rubyandrails.info/books/rebuilding-rails)
5. [RubyConfTH 2022 - Dissecting Rails Talk](https://www.youtube.com/watch?v=gXwRs-FwcmE)
6. [My demo sandbox](https://github.com/friendlyantz/demystifying-rails)


----

# Rails new commands

```zsh
rails new app_name \
--database=sqlite3 \
--css=tailwind \
--skip-test
```

# Kamal

```
kamal init
```