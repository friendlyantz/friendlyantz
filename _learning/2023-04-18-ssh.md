---
# layout: posts
title: "SSH with U2F"
permalink: /ssh
excerpt: "never user passwords, always use hardware keys"
last_modified_at: 2023-04-21T13:12-04:00
collection: learning
categories:
  - software_engineering
  - learning
tags:
  - software_engineering
  - learning
---


> 1. NEVER USER PASSWORDS, ALWAYS USE KEYS
> 2. Use 2FA to protect your Private Keys -> U2F i.e. Yubikey, Flipper Zero

---
Table of contents 
* Table of contents (do not remove this line)
{:toc}

# Setup Client (where you want to connect from)
## Generate ssh keys backed up by hardware key U2F

Traditionally we would generate ssh keys using `ssh-keygen ` and then copy the public key to the server. For example:
```sh
ssh-keygen -t ed25519 # ed25519 is  most secure algorythm atm # tip: cd into ~/.ssh dir before running this
# or
ssh-keygen -t ecdsa # less secure
```
This is not secure as the private key is stored on the client and if the client is compromised then the attacker can use the private key to connect to the server.

To mitigate this we can use a hardware key to store the private key. Hardware kyes are supported by OpenSSH 8.2 and above.

There are two types of ssh keys 
- Discoverable(aka resident keys) (less secure) - the private key is stored on the hardware key and is always available
- Non-Discoverable (more secure) - the private key is stored on the hardware key but is not always available. The private key is only available when the hardware key is plugged in.

#### Using Yubikey 
`ssh-keygen -t ed25519-sk` # most secure # tip: cd into ~/.ssh dir before running this

`-sk` means hardware key
### Using Flipper Zero

Flipper Zero supports only `ecdsa-sk`

### Links & Resources
1. [Official YubiCo tutorial](https://developers.yubico.com/SSH/Securing_SSH_with_FIDO2.html)
1. [Linux tutorial](https://forums.lawrencesystems.com/t/ssh-with-yubikey-fido-u2f-authentication/13024)
1. [Mac tutorial tackling issues with Apple SSH agent](https://aditsachde.com/posts/yubikey-ssh/)

---

# Setup Server(where you want to connect to)

### Install

```bash
sudo apt-get install openssh-server
```

```bash
sudo service ssh start
# below might be required
# sudo systemctl enable ssh
```

### Authorize Keys

```bash
mkdir .ssh
chmod 700 .ssh
vim .ssh/authorized_keys
chmod 600 authorized_keys
# paste your public key content from the client
```

### Disable Password (IMPORTANTðŸš¨)

in `/etc/ssh/sshd_config` update:

```vim
PasswordAuthentication no
```
then
```bash
sudo service ssh restart
```

### Debug / See logs on the Server on who connected via SSH

```bash
# opt 1: redundant / superseded by opt 2
sudo tail -f /var/log/auth.log
# opt 2
sudo journalctl -f -u ssh.service
# where -f is to follow / live tail
```
